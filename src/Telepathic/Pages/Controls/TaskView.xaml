<?xml version="1.0" encoding="utf-8" ?>
<Border
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:effectsView="clr-namespace:Syncfusion.Maui.Toolkit.EffectsView;assembly=Syncfusion.Maui.Toolkit"
    xmlns:pageModels="clr-namespace:Telepathic.PageModels"
    xmlns:models="clr-namespace:Telepathic.Models"
    xmlns:shimmer="clr-namespace:Syncfusion.Maui.Toolkit.Shimmer;assembly=Syncfusion.Maui.Toolkit"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:converters="clr-namespace:Telepathic.Converters"
    xmlns:controls="clr-namespace:Telepathic.Pages.Controls"
    xmlns:fonts="clr-namespace:Fonts"
    x:Class="Telepathic.Pages.Controls.TaskView"
    x:Name="rootBorder"
    StrokeShape="RoundRectangle 20"
    BackgroundColor="{toolkit:AppThemeResource Surface0}"
    StrokeThickness="{Binding IsRecommendation, Converter={StaticResource BoolToThicknessConverter}, ConverterParameter=2}"
    x:DataType="models:ProjectTask">
      <Border.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <converters:BoolToFontAttributesConverter x:Key="BoolToFontAttributesConverter" />
        
        
        <toolkit:BoolToObjectConverter x:Key="BoolToBorderBrushConverter" 
                                     TrueObject="{StaticResource AIBrush}" 
                                     FalseObject="Transparent" />
        <!-- Converter to show assist button when AssistType is not None -->
        <converters:AssistTypeToBoolConverter x:Key="AssistTypeToBoolConverter" />
    </Border.Resources>
    
    <Border.Stroke>
        <Binding Path="IsRecommendation" Converter="{StaticResource BoolToBorderBrushConverter}" />
    </Border.Stroke>
    
    <effectsView:SfEffectsView
        TouchDownEffects="Highlight"
        HighlightBackground="{toolkit:AppThemeResource OnBackground}">
        <shimmer:SfShimmer
            BackgroundColor="Transparent"
            VerticalOptions="Fill"               
            IsActive="{Binding IsBusy, Source={RelativeSource AncestorType={x:Type pageModels:IProjectTaskPageModel}}, x:DataType=pageModels:IProjectTaskPageModel}">
            <shimmer:SfShimmer.CustomView>
                <Grid 
                    ColumnDefinitions="Auto,*"
                    Padding="{OnIdiom 15, Desktop=20}">
                    <BoxView 
                        WidthRequest="24"
                        HeightRequest="24"
                        Margin="12, 0"
                        Style="{StaticResource ShimmerCustomViewStyle}"/>
                    <BoxView 
                        Grid.Column="1"
                        HeightRequest="24"
                        Margin="12, 0"
                        Style="{StaticResource ShimmerCustomViewStyle}"/>
                </Grid>
            </shimmer:SfShimmer.CustomView>
            <shimmer:SfShimmer.Content>
                <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="15" Padding="{OnIdiom 15, Desktop=20}">
                    <Grid.GestureRecognizers>
                        <TapGestureRecognizer 
                            Command="{Binding NavigateToTaskCommand, Source={RelativeSource AncestorType={x:Type pageModels:IProjectTaskPageModel}}, x:DataType=pageModels:IProjectTaskPageModel}" 
                            CommandParameter="{Binding .}"/>
                    </Grid.GestureRecognizers>
                    
                    <!-- Regular task completion checkbox (visible for all tasks) -->
                    <CheckBox 
                        Grid.Column="0" 
                        IsChecked="{Binding IsCompleted, Mode=OneTime}" 
                        VerticalOptions="Center" 
                        CheckedChanged="CheckBox_CheckedChanged"/>
                    
                    <!-- Task Title (Normal or italic for recommendation) -->
                    <Label 
                        Grid.Column="1" 
                        Text="{Binding Title}"
                        VerticalOptions="Center" 
                        LineBreakMode="TailTruncation"
                        FontAttributes="{Binding IsRecommendation, Converter={StaticResource BoolToFontAttributesConverter}}"/>

                    <!-- Trashcan Button (only visible for recommendations) -->
                    <Button
                        Grid.Column="2"
                        WidthRequest="40"
                        HeightRequest="40"
                        CornerRadius="20"
                        Padding="0"
                        BackgroundColor="Transparent"
                        IsVisible="{Binding IsRecommendation}"
                        Command="{Binding RejectRecommendationCommand, Source={RelativeSource AncestorType={x:Type pageModels:IProjectTaskPageModel}}, x:DataType=pageModels:IProjectTaskPageModel}"
                        CommandParameter="{Binding .}"
                        Text="{x:Static fonts:FluentUI.delete_32_regular}"
                        FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                        FontSize="24"
                        TextColor="{toolkit:AppThemeResource OnBackground}"/>
                    <!-- Assist Button (visible when AssistType != None) -->
                    <Button
                        Grid.Column="3"
                        WidthRequest="40"
                        HeightRequest="40"
                        CornerRadius="20"
                        Padding="0"
                        BackgroundColor="Transparent"
                        IsVisible="{Binding AssistType, Converter={StaticResource AssistTypeToBoolConverter}}"
                        Command="{Binding AssistCommand, Source={RelativeSource AncestorType={x:Type pageModels:IProjectTaskPageModel}}, x:DataType=pageModels:IProjectTaskPageModel}"
                        CommandParameter="{Binding .}"
                        Text="{x:Static fonts:FluentUI.wand_48_regular}"
                        FontFamily="{x:Static fonts:FluentUI.FontFamily}"
                        FontSize="24"
                        TextColor="{toolkit:AppThemeResource OnBackground}"/>
                </Grid>
            </shimmer:SfShimmer.Content>
        </shimmer:SfShimmer>
    </effectsView:SfEffectsView>
</Border>